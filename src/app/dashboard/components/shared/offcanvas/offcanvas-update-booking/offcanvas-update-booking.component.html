<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasUpdateBooking" aria-labelledby="offcanvasUpdateBookingLabel">
  <div class="offcanvas-header border-bottom">
    <h6 class="offcanvas-title text-white fw-normal fs-18" id="offcanvasUpdateBookingLabel">
      <i class="bx bx-calendar-edit me-2"></i>
      Update booking
    </h6>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body shadow-sm p-0">
    
    <div *ngIf="loadingBooking" class="d-flex justify-content-center align-items-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <form [formGroup]="bookingForm" class="p-4" *ngIf="!loadingBooking">

      <div class="mb-3">
        <label class="form-label">Stylist</label>
        <div class="form-control-static p-3 border rounded">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="bx bx-user text-white"></i>
              </div>
            </div>
            <div>
              <h6 class="mb-0 fw-bold">{{selectedStylist ? getUserFullName(selectedStylist) : 'No asignado'}}</h6>
              <small class="text-muted">Stylist assigned</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Client Section -->
      <div class="mb-3">
        <label class="form-label">Customer</label>
        <div class="form-control-static p-3 border rounded">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <img *ngIf="customer" class="rounded-circle" [src]="getCustomerPhoto(customer)" alt="Cliente" style="width: 40px; height: 40px;">
              <div *ngIf="!customer" class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="bx bx-user text-white"></i>
              </div>
            </div>
            <div class="flex-grow-1">
              <h6 class="mb-0 fw-bold">{{customer ? getCustomerFullName(customer) : 'No asignado'}}</h6>
              <small class="text-muted">{{customer && getUserForCustomer(customer)?.email ? getUserForCustomer(customer)?.email : 'Cliente del booking'}}</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Services Section -->
      <div class="mb-3">
        <label class="form-label">Servicios</label>
        
        <div *ngIf="selectedServices.length > 0">
          <div class="row">
            <div class="col-12" *ngFor="let service of selectedServices; let i = index">
              <div class="d-flex align-items-center p-2 mb-2 border rounded bg-white">
                <div class="me-3">
                  <div [ngStyle]="{'background-color': getServiceColor(service)}" 
                        style="color: white; width: 35px; height: 35px;"
                        class="rounded d-flex align-items-center justify-content-center">
                    <i class="bx bx-cut"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-0 fw-bold">
                    {{getServiceName(service)}}
                    <span *ngIf="hasServiceModifier(service)" class="badge bg-info ms-2">
                      <i class="bx bx-pencil"></i> Personalizado
                    </span>
                  </h6>
                  
                  <!-- Precio y duración original (tachado si hay modificador) -->
                  <small class="text-muted d-block" [class.text-decoration-line-through]="hasServiceModifier(service)">
                    {{service.durationMinutes}}min - {{service.price || 0}} {{service.currency || 'USD'}}
                  </small>
                  
                  <!-- Precio y duración personalizada (solo si hay modificador) -->
                  <small *ngIf="hasServiceModifier(service)" class="text-success d-block fw-bold">
                    <i class="bx bx-check-circle me-1"></i>
                    {{getServiceDisplayDuration(service)}}min - {{getServiceDisplayPrice(service) || 0}} {{service.currency || 'USD'}}
                  </small>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-3 p-3 bg-primary bg-opacity-10 rounded">
            <div class="row">
              <div class="col-6">
                <small class="text-muted">Duración total:</small>
                <p class="mb-0 fw-bold text-primary">{{calculateTotalDuration()}} minutos</p>
              </div>
              <div class="col-6">
                <small class="text-muted">Precio total:</small>
                <p class="mb-0 fw-bold text-primary">{{calculateTotalPrice()}} {{selectedServices.length > 0 ? selectedServices[0].currency || 'COP' : 'COP'}}</p>
              </div>
            </div>
          </div>
        </div>
        
        <div *ngIf="selectedServices.length === 0" class="form-control-static p-3 border rounded bg-light text-center">
          <i class="bx bx-info-circle text-muted me-2"></i>
          <span class="text-muted">No services assigned to this booking</span>
        </div>
      </div>



      <!-- Date and Time Section -->
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Booking date</label>
            <input type="date" class="form-control" formControlName="bookingDate">
            <div *ngIf="bookingForm.get('bookingDate')?.invalid && bookingForm.get('bookingDate')?.touched" class="text-danger small mt-1">
              Booking date required
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Start time</label>
            <input type="time" class="form-control" formControlName="startTime">
            <div *ngIf="bookingForm.get('startTime')?.invalid && bookingForm.get('startTime')?.touched" class="text-danger small mt-1">
              Start time required
            </div>
          </div>
        </div>
      </div>

      <!-- Duration Section -->
      <div class="mb-3">
          <label class="form-label">Duration (minutes)</label>
        <input type="number" 
               class="form-control" 
               formControlName="durationMinutes" 
               min="15" 
               max="480" 
               placeholder="60" 
               [readonly]="selectedServices.length > 0">
        <div *ngIf="bookingForm.get('durationMinutes')?.invalid && bookingForm.get('durationMinutes')?.touched" class="text-danger small mt-1">
          <span *ngIf="bookingForm.get('durationMinutes')?.errors?.['required']">Duration required</span>
          <span *ngIf="bookingForm.get('durationMinutes')?.errors?.['min']">Minimum duration: 15 minutes</span>
          <span *ngIf="bookingForm.get('durationMinutes')?.errors?.['max']">Maximum duration: 8 hours</span>
        </div>
        <div *ngIf="selectedServices.length > 0" class="form-text">
          <i class="bx bx-info-circle me-1"></i>
          The duration is calculated automatically based on the selected services
        </div>
      </div>

      <!-- Status Section -->
      <div class="mb-3">
        <label class="form-label">Booking status</label>
        <select class="form-select" formControlName="status">
          <option [value]="statusOption.value" *ngFor="let statusOption of getStatusOptions()">
            {{statusOption.label}}
          </option>
        </select>
      </div>

      <!-- Notes Section -->
      <div class="mb-3">
        <label class="form-label">Customer notes</label>
        <textarea class="form-control" 
                  formControlName="clientNotes" 
                  rows="3" 
                  placeholder="Additional customer notes..."></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Provider notes</label>
        <textarea class="form-control" 
                  formControlName="providerNotes" 
                  rows="3" 
                  placeholder="Internal provider notes..."></textarea>
      </div>

      <!-- Action Buttons -->
      <div class="d-grid gap-2 pt-3 border-top">
        <button type="button" 
                (click)="onConfirm()" 
                [disabled]="!isFormValid() || loading"
                class="btn btn-primary waves-effect waves-light">
          <i class="bx bx-calendar-edit me-2" *ngIf="!loading"></i>
          <div class="spinner-border spinner-border-sm me-2" role="status" *ngIf="loading">
            <span class="visually-hidden">Loading...</span>
          </div>
          <span *ngIf="!loading">Update booking</span>
          <span *ngIf="loading">Updating...</span>
        </button>
        
        <button type="button" 
                (click)="onCancel()" 
                class="btn btn-outline-secondary waves-effect waves-light"
                [disabled]="loading">
          <i class="bx bx-x me-2"></i>
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>
