<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCreateBooking" aria-labelledby="offcanvasCreateBookingLabel">
  <div class="offcanvas-header border-bottom">
    <h6 class="offcanvas-title text-white fw-normal fs-18" id="offcanvasCreateBookingLabel">
      <i class="bx bx-calendar-plus me-2"></i>
      Crear nueva reserva
    </h6>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body shadow-sm p-0">
    <form [formGroup]="bookingForm" class="p-4">
      <!-- Selección de servicios -->
      <div class="mb-3">
        <label class="form-label">Servicios *</label>
        <div class="row">
          <div class="col-md-10">
            <select class="form-select" (change)="onServiceChange($event)">
              <option [value]="null">Seleccionar servicio</option>
              <option [value]="service.id" *ngFor="let service of getAvailableServices()">
                {{getServiceName(service)}} - {{service.price || 0}} {{service.currency || 'USD'}}
              </option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-outline-primary btn-rounded waves-effect waves-light">
              <i class="bx bx-plus"></i>
            </button>
          </div>
        </div>
        
        <!-- Lista de servicios seleccionados -->
        <div *ngIf="selectedServices.length > 0" class="mt-3">
          <h6 class="mb-2">Servicios seleccionados:</h6>
          <div class="row">
            <div class="col-12" *ngFor="let service of selectedServices; let i = index">
              <div class="d-flex align-items-center justify-content-between p-2 mb-2 border rounded">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <button type="button" 
                            [matTooltip]="getServiceColor(service)" 
                            [ngStyle]="{'background-color': getServiceColor(service)}" 
                            style="color: white; width: 30px; height: 30px;"
                            class="btn btn-sm btn-rounded waves-effect waves-light d-flex align-items-center justify-content-center">
                      <i class="bx bx-cut"></i>
                    </button>
                  </div>
                  <div>
                    <h6 class="mb-0">{{getServiceName(service)}}</h6>
                    <small class="text-muted">
                      {{service.durationMinutes}}min - {{service.price || 0}} {{service.currency || 'USD'}}
                    </small>
                  </div>
                </div>
                <button type="button" 
                        (click)="removeService(service.id)" 
                        class="btn btn-sm btn-outline-danger btn-rounded waves-effect waves-light">
                  <i class="bx bx-trash"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Resumen total -->
          <div class="p-3 bg-light rounded">
            <div class="row">
              <div class="col-6">
                <small class="text-muted">Duración total:</small>
                <p class="mb-0 fw-bold">{{calculateTotalDuration()}} minutos</p>
              </div>
              <div class="col-6">
                <small class="text-muted">Precio total:</small>
                <p class="mb-0 fw-bold">{{calculateTotalPrice()}} {{selectedServices[0]!.currency || 'USD'}}</p>
              </div>
            </div>
          </div>
        </div>
        
        <div *ngIf="selectedServices.length === 0" class="text-danger small mt-1">
          Debe seleccionar al menos un servicio
        </div>
      </div>

      <!-- Selección de cliente -->
      <div class="mb-3">
        <label class="form-label">Cliente *</label>
        <div class="row">
          <div class="col-md-10">
            <select class="form-select" (change)="onCustomerChange($event)" formControlName="customerId">
              <option [value]="null">Seleccionar cliente</option>
              <option [value]="customer.id" *ngFor="let customer of customers">{{getCustomerFullName(customer)}}</option>
            </select>
            <div *ngIf="bookingForm.get('customerId')?.invalid && bookingForm.get('customerId')?.touched" class="text-danger small mt-1">
              Cliente requerido
            </div>
          </div>
          <div class="col-md-2">
            <button *ngIf="customer != null" type="button" class="btn btn-circle p-0 d-flex align-items-center"
              id="page-header-user-dropdown-v" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <img class="rounded-circle header-profile-user" [src]="getCustomerPhoto(customer)" alt="Header Avatar">
            </button>

            <div *ngIf="customer != null" class="dropdown-menu dropdown-menu-end pt-0">
              <div class="p-3 border-bottom">
                <h6 class="mb-0">{{getCustomerFullName(customer)}}</h6>
                <p class="mb-0 font-size-11 text-muted">{{getUserForCustomer(customer)?.email || 'Sin email'}}</p>
              </div>
              <a class="dropdown-item" href="#"><i class="mdi mdi-account-circle text-muted font-size-16 align-middle me-1"></i> <span class="align-middle">Perfil</span></a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item cursor"><i class="mdi mdi-logout text-muted font-size-16 align-middle me-1"></i> <span class="align-middle">Cerrar sesión</span></a>
            </div>
            
            <button *ngIf="customer == null" type="button" style="border: 1px solid #e0e0e0; background-color: white; color: #999" class="btn btn-ligth btn-rounded waves-effect waves-light">
              <i class="bx bx-user"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Fecha y hora -->
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Fecha de reserva *</label>
            <input type="date" class="form-control" formControlName="bookingDate">
            <div *ngIf="bookingForm.get('bookingDate')?.invalid && bookingForm.get('bookingDate')?.touched" class="text-danger small mt-1">
              Fecha de reserva requerida
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Hora de inicio *</label>
            <input type="time" class="form-control" formControlName="startTime">
            <div *ngIf="bookingForm.get('startTime')?.invalid && bookingForm.get('startTime')?.touched" class="text-danger small mt-1">
              Hora de inicio requerida
            </div>
          </div>
        </div>
      </div>

      <!-- Duración y estado -->
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Duración (minutos) *</label>
            <input type="number" class="form-control" formControlName="durationMinutes" min="15" max="480" placeholder="60" [readonly]="selectedServices.length > 0">
            <div *ngIf="bookingForm.get('durationMinutes')?.invalid && bookingForm.get('durationMinutes')?.touched" class="text-danger small mt-1">
              <span *ngIf="bookingForm.get('durationMinutes')?.errors?.['required']">Duración requerida</span>
              <span *ngIf="bookingForm.get('durationMinutes')?.errors?.['min']">Duración mínima: 15 minutos</span>
              <span *ngIf="bookingForm.get('durationMinutes')?.errors?.['max']">Duración máxima: 8 horas</span>
            </div>
           
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Estado</label>
            <select class="form-select" formControlName="status">
              <option [value]="BookingStatus.Pending">
                <i class="bx bx-time-five"></i> Pendiente
              </option>
              <option [value]="BookingStatus.Confirmed">
                <i class="bx bx-check"></i> Confirmada
              </option>
              <option [value]="BookingStatus.InProgress">
                <i class="bx bx-play"></i> En progreso
              </option>
              <option [value]="BookingStatus.Completed">
                <i class="bx bx-check-double"></i> Completada
              </option>
              <option [value]="BookingStatus.Cancelled">
                <i class="bx bx-x"></i> Cancelada
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Notas -->
      <div class="mb-3">
        <label class="form-label">Notas del cliente</label>
        <textarea class="form-control" formControlName="clientNotes" rows="3" placeholder="Notas adicionales del cliente..."></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Notas del proveedor</label>
        <textarea class="form-control" formControlName="providerNotes" rows="3" placeholder="Notas internas del proveedor..."></textarea>
      </div>

      <!-- Botón de acción -->
      <div class="d-grid gap-2 pt-3 border-top">
        <button type="button" 
                (click)="onConfirm()" 
                [disabled]="!isFormValid() || loading"
                class="btn btn-primary waves-effect waves-light">
          <i class="bx bx-calendar-plus me-2"></i>
          <span *ngIf="!loading">Crear reserva</span>
          <span *ngIf="loading">Creando...</span>
        </button>       
      </div>
    </form>
  </div>
</div>
